<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SABROSON</title>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
     
     <link rel="stylesheet" href="./css/style.css">
      
    
    </head>


    <body>
        
      <nav class="navbar navbar-expand-md navbar-dark ">
        <div class="container">
            <a href="/" class="navbar-brand d-flex align-items-center">
                <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"></use></svg>
                <span class="fs-4">SABROSON</span>
            </a>
    
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
    
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav ms-auto mb-2 mb-md-0">
                    <li class="nav-item"><a href="/index.html" class="nav-link mt-1 fs-5 font-weight-bold" aria-current="page">Inicio</a></li>
                    <li class="nav-item"><a href="/menu.html" class="nav-link mt-1 fs-5 font-weight-bold">Menu de comida</a></li>
                    <li class="nav-item"><a href="/login.html" class="nav-link mt-1 fs-5 font-weight-bold">Admin</a></li>
                </ul>
            </div>
        </div>
    </nav>


    <!-- ---------------------------------------------------------------------- -->


   

    
  <div id="container-general-form" style="display: block;">

          <div class="container mt-5">
            <div class="row justify-content-center">
              <div class="col-md-6">
                <h2>Chateanos!</h2>
              </div>
            </div>
          </div>
    
  </div>

  <div class="container container-general-chat" >

                <div class="container container-message">  
                    <div id="conversation"></div>
                </div>

    <div class="container" id="chat">
            

                <form id="chat-form">

                        <textarea name="message" id="text-message" ></textarea>
                        <button type="submit" class="btn-send-chat">enviar</button>
                
                </form>

    </div>
</div>

<section id="footer" class="footer p-5">
    <footer id="footer">

      <div class="container d-flex justify-content-between align-items-center">

        <div>
          <h3>SABROSON</h3>
        </div>

        <div>
          <div class="copyright">
            &copy; Copyright <strong><span>SABROSON</span></strong>. All Rights Reserved
          </div>
        </div>
      </div>
    </footer>
  </section>


<script type="module">

import app from './config/config.js';
import { 
    getAuth, 
    onAuthStateChanged 
} from "https://cdnjs.cloudflare.com/ajax/libs/firebase/10.3.0/firebase-auth.min.js";

import { 
    getDatabase, 
    ref, 
    push, 
    query, 
    orderByChild, 
    equalTo, 
    onValue 
} from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js';

const db = getDatabase(app);
const auth = getAuth(app);
const conversation = document.getElementById('conversation');
const chatForm = document.getElementById("chat-form");
const chatTextarea = document.getElementById('text-message');

// Función para mostrar los mensajes
function displayMessages(messages) {
    conversation.innerHTML = ''; // Limpiamos el área de conversación antes de mostrar los mensajes
    Object.values(messages).forEach(message => {
        conversation.innerHTML += `
            <div class="message-txt">
                <p>Usuario ID: ${message.userId}</p>
                <p>Mensaje: ${message.message}</p>
            </div>
        `;
    });
}

// Escuchamos cambios en los mensajes cuando el usuario inicia sesión
onAuthStateChanged(auth, (user) => {
    if (user) {
        const messagesRef = ref(db, 'messages');

        onValue(messagesRef, (snapshot) => {
            if (snapshot.exists()) {
                const messages = snapshot.val();
                displayMessages(messages);
            }
        });
    } else {
        console.log('No hay usuario autenticado');
        // Podrías redirigirlo a una página de inicio de sesión, por ejemplo
        // window.location.href = "/login.html";
    }
});

// Manejamos el envío de mensajes
chatForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const user = auth.currentUser;
    if (user) {
        const message = chatTextarea.value.trim();

        if (message !== '') {
            const messagesRef = ref(db, 'messages');
            push(messagesRef, {
                userId: user.uid,
                message: message,
                createdAt: new Date().toISOString() // Podrías utilizar otro formato de fecha si lo prefieres
            });

            chatTextarea.value = ''; // Limpiamos el área del mensaje después de enviarlo
        }
    } else {
        console.log('No hay usuario autenticado');
        // Manejar el caso cuando el usuario no está autenticado
        // window.location.href = "/login.html";
    }
});


</script>


</body>
</html>